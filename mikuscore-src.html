<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mikuscore</title>
  <link rel="stylesheet" href="src/css/md3/token-spec.css" />
  <link rel="stylesheet" href="src/css/md3/core-spec.css" />
  <link rel="stylesheet" href="src/css/app.css" />
</head>
<body class="md-page">
  <main class="md-shell">
    <section class="md-card ms-app">
      <header class="ms-hero">
        <div class="ms-hero-top">
          <p class="ms-hero-eyebrow">LOCAL SCORE TOOL</p>
          <span class="md-chip ms-hero-chip">v0.1.0</span>
        </div>
        <h1 class="md-headline ms-hero-title">
          <span class="ms-hero-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M9 3v12.4a3.6 3.6 0 1 1-1.2-2.7V6.2l9-2.2v9.6a3.6 3.6 0 1 1-1.2-2.7V5.6L9 7.1Z" />
            </svg>
          </span>
          <span>mikuscore</span>
          <span class="md-tooltip-group">
            <span class="md-info-chip" aria-label="mikuscore の詳細説明">
              <svg aria-hidden="true" viewBox="0 0 24 24" class="md-info-icon" fill="none">
                <circle cx="12" cy="12" r="9" fill="#cbbcf0"></circle>
                <rect x="11" y="10" width="2" height="7" rx="1" fill="#ffffff"></rect>
                <circle cx="12" cy="7.5" r="1" fill="#ffffff"></circle>
              </svg>
            </span>
            <span class="md-tooltip-content md-tooltip md-tooltip--rich md-tooltip--wide">
              mikuscore は、MusicXML の既存構造をできるだけ保持しながら編集することを重視したローカル完結型エディタです。
              入力（ファイル/ソース）から譜面プレビュー、ノート編集、再生確認、保存/ダウンロードまでを一画面で行えます。
              操作手順: 1) 入力を選んで読み込み 2) 譜面プレビューで選択 3) ノートを編集 4) 再生で確認して保存 / ダウンロード。
              まず読み込み後に譜面をクリックして対象ノートを選び、音高・音価を調整してください。
            </span>
          </span>
        </h1>
        <p class="md-subtitle ms-hero-subtitle">
          ブラウザ上で完結し、既存MusicXMLを壊さずに編集することを重視したスコアエディタです。
        </p>
      </header>

      <div class="ms-flow">
        <details id="inputSectionDetails" class="md-section ms-flow-step ms-flow-collapsible" open>
          <summary class="ms-flow-summary">
            <span class="md-section-title"><span class="ms-step-no">1</span>MusicXML入力</span>
            <span class="ms-flow-summary-meta">
              <span class="ms-flow-state">折りたたみ中</span>
              <span class="ms-flow-caret" aria-hidden="true">▾</span>
            </span>
          </summary>
          <div class="ms-flow-body">
          <div class="ms-radio-group" role="radiogroup" aria-label="入力方式">
            <label class="md-radio"><input id="inputModeFile" type="radio" name="inputMode" value="file" checked /> ファイル読込</label>
            <label class="md-radio"><input id="inputModeSource" type="radio" name="inputMode" value="source" /> ソース入力</label>
            <label class="md-radio"><input id="inputModeAbc" type="radio" name="inputMode" value="abc" /> ABC入力</label>
          </div>

          <div id="fileInputBlock" class="ms-block">
            <button id="fileSelectBtn" type="button" class="md-button md-button--tonal">ファイルを選択</button>
            <span id="fileNameText" class="ms-file-name">未選択</span>
            <input id="fileInput" type="file" accept=".musicxml,.xml,.abc,text/plain,text/xml,application/xml" hidden />
          </div>

          <div id="sourceInputBlock" class="ms-block md-hidden">
            <label for="xmlInput" class="md-label">MusicXML</label>
            <textarea id="xmlInput" rows="12" spellcheck="false" class="md-textarea"></textarea>
          </div>

          <div id="abcInputBlock" class="ms-block md-hidden">
            <label for="abcInput" class="md-label">ABC</label>
            <textarea id="abcInput" rows="12" spellcheck="false" class="md-textarea"></textarea>
          </div>

          <div class="ms-actions">
            <button id="loadBtn" type="button" class="md-button md-button--primary">読み込み</button>
          </div>
          </div>
        </details>

        <section class="md-section ms-flow-step">
          <h2 class="md-section-title">
            <span class="ms-step-no">2</span>譜面プレビュー（クリックで選択）
            <span class="md-tooltip-group">
              <span class="md-info-chip" aria-label="譜面プレビューの説明">
                <svg aria-hidden="true" viewBox="0 0 24 24" class="md-info-icon" fill="none">
                  <circle cx="12" cy="12" r="9" fill="#cbbcf0"></circle>
                  <rect x="11" y="10" width="2" height="7" rx="1" fill="#ffffff"></rect>
                  <circle cx="12" cy="7.5" r="1" fill="#ffffff"></circle>
                </svg>
              </span>
              <span class="md-tooltip-content md-tooltip md-tooltip--rich md-tooltip--wide">
                音符をクリックすると、編集対象として選択します。
              </span>
            </span>
          </h2>
          <div class="ms-actions ms-preview-actions">
            <button id="playBtn" type="button" class="md-button md-button--primary ms-icon-button">
              <svg aria-hidden="true" viewBox="0 0 24 24" class="ms-btn-icon" fill="currentColor">
                <path d="M8 6.5v11l9-5.5z"></path>
              </svg>
              <span>再生</span>
            </button>
            <button id="stopBtn" type="button" class="md-button md-button--surface ms-icon-button" disabled>
              <svg aria-hidden="true" viewBox="0 0 24 24" class="ms-btn-icon" fill="currentColor">
                <rect x="7" y="7" width="10" height="10" rx="1.5"></rect>
              </svg>
              <span>停止</span>
            </button>
          </div>
          <div id="debugScoreWrap" class="ms-debug-wrap">
            <div id="debugScoreArea" class="ms-debug-score"></div>
          </div>
        </section>

        <section class="md-section ms-flow-step">
          <h2 class="md-section-title"><span class="ms-step-no">3</span>編集</h2>
          <div id="uiMessage" class="ms-ui-message md-hidden" role="status" aria-live="polite"></div>
          <p id="measurePartNameText" class="ms-track-label">トラック名: -</p>
          <p id="measureSelectionText" class="ms-status">小節未選択（譜面プレビューをクリックしてください）</p>
          <div id="measureEditorWrap" class="ms-measure-editor md-hidden">
            <div id="measureEditorArea" class="ms-debug-score"></div>
          </div>
          <div class="ms-actions">
            <button id="measureApplyBtn" type="button" class="md-button md-button--primary ms-icon-button" disabled>
              <svg aria-hidden="true" viewBox="0 0 24 24" class="ms-btn-icon" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 7L9 18l-5-5"></path>
              </svg>
              <span>小節編集確定</span>
            </button>
            <button id="measureDiscardBtn" type="button" class="md-button md-button--surface ms-icon-button" disabled>
              <svg aria-hidden="true" viewBox="0 0 24 24" class="ms-btn-icon" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 6L6 18"></path>
                <path d="M6 6l12 12"></path>
              </svg>
              <span>小節編集破棄</span>
            </button>
            <button id="playMeasureBtn" type="button" class="md-button md-button--tonal ms-icon-button" disabled>
              <svg aria-hidden="true" viewBox="0 0 24 24" class="ms-btn-icon" fill="currentColor">
                <path d="M8 6.5v11l9-5.5z"></path>
              </svg>
              <span>小節再生</span>
            </button>
          </div>

          <div class="ms-grid">
            <label class="ms-field">音名(step)
              <div class="ms-step-row">
                <input id="pitchStep" type="hidden" value="" />
                <span id="pitchStepValue" class="ms-step-value" aria-live="polite">休符</span>
                <button id="pitchStepDownBtn" type="button" class="md-button md-button--surface ms-step-btn" aria-label="音名を下げる">↓</button>
                <button id="pitchStepUpBtn" type="button" class="md-button md-button--surface ms-step-btn" aria-label="音名を上げる">↑</button>
              </div>
            </label>
            <label class="ms-field">変化記号(alter)
              <div class="ms-alter-row" role="group" aria-label="変化記号">
                <input id="pitchAlter" type="hidden" value="none" />
                <button type="button" class="md-button md-button--surface ms-alter-btn" data-alter="none" aria-label="変化記号なし">なし</button>
                <button type="button" class="md-button md-button--surface ms-alter-btn" data-alter="-2" aria-label="ダブルフラット">♭♭</button>
                <button type="button" class="md-button md-button--surface ms-alter-btn" data-alter="-1" aria-label="フラット">♭</button>
                <button type="button" class="md-button md-button--surface ms-alter-btn" data-alter="0" aria-label="ナチュラル">♮</button>
                <button type="button" class="md-button md-button--surface ms-alter-btn" data-alter="1" aria-label="シャープ">♯</button>
                <button type="button" class="md-button md-button--surface ms-alter-btn" data-alter="2" aria-label="ダブルシャープ">♯♯</button>
              </div>
            </label>
            <input id="pitchOctave" type="hidden" value="4" />
            <label class="ms-field">音価(duration)
              <select id="durationPreset" class="md-select" aria-label="音価プリセット">
                <option value="">（音価を選択）</option>
              </select>
            </label>
          </div>

          <div class="ms-actions">
            <button id="convertRestBtn" type="button" class="md-button md-button--tonal ms-icon-button">
              <svg aria-hidden="true" viewBox="0 0 34 24" class="ms-btn-icon ms-btn-icon--wide" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                <!-- quarter rest (wide, readable silhouette) -->
                <path d="M6.5 3.6c4 1.7 5.4 4.2 2.9 7.3-1.2 1.4-1.2 2.7.6 4.1 1.5 1.2 3.6 2 5.2 3.5"></path>
                <path d="M9.2 7.6c2.2 1.2 3.4 2.8 2 4.6"></path>
                <path d="M11.8 15.3c1.6.8 2.8 1.5 4 2.6"></path>
                <!-- convert arrow -->
                <path d="M16.8 12h5.2"></path>
                <path d="M20.2 9.5l2.6 2.5-2.6 2.5"></path>
                <!-- quarter note -->
                <circle cx="27.3" cy="15.9" r="2.2" fill="currentColor" stroke="none"></circle>
                <path d="M29.3 15.9V7.1"></path>
              </svg>
              <span>休符を音符化</span>
            </button>
            <button id="splitNoteBtn" type="button" class="md-button md-button--tonal ms-icon-button">
              <svg aria-hidden="true" viewBox="0 0 24 24" class="ms-btn-icon" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="7.5" cy="15.5" r="2.5" fill="currentColor" stroke="none"></circle>
                <path d="M10 15.5V8"></path>
                <path d="M12 6v12"></path>
                <circle cx="16.5" cy="15.5" r="2.5" fill="currentColor" stroke="none"></circle>
                <path d="M19 15.5V8"></path>
              </svg>
              <span>音符分割</span>
            </button>
            <button id="deleteBtn" type="button" class="md-button md-button--surface ms-icon-button">
              <svg aria-hidden="true" viewBox="0 0 24 24" class="ms-btn-icon" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 7h16"></path>
                <path d="M9 7V5h6v2"></path>
                <rect x="6.5" y="7" width="11" height="13" rx="1.5"></rect>
                <path d="M10 10v7"></path>
                <path d="M14 10v7"></path>
              </svg>
              <span>音符削除</span>
            </button>
          </div>
        </section>

        <section class="md-section ms-flow-step">
          <h2 class="md-section-title"><span class="ms-step-no">4</span>保存</h2>
          <div class="ms-actions">
            <button id="downloadBtn" type="button" class="md-button md-button--secondary" disabled>MusicXML出力</button>
            <button id="downloadMidiBtn" type="button" class="md-button md-button--tonal" disabled>MIDI出力</button>
            <button id="downloadAbcBtn" type="button" class="md-button md-button--tonal" disabled>ABC出力</button>
          </div>
        </section>
      </div>

      <details class="ms-dev">
        <summary>詳細情報</summary>
        <section class="md-section">
          <h2 class="md-section-title">状態</h2>
          <p id="statusText" class="ms-status">未ロード</p>
          <p id="playbackText" class="ms-status">再生: 停止中</p>
          <p class="ms-status">保存モード: <span id="saveModeText">-</span></p>
        </section>
        <section class="md-section">
          <h2 class="md-section-title">ノート選択</h2>
          <label for="noteSelect" class="md-label">ノート選択 (nodeId)</label>
          <select id="noteSelect" class="md-select"></select>
        </section>
        <section class="md-section">
          <h2 class="md-section-title">診断</h2>
          <div id="diagArea" aria-live="polite"></div>
        </section>
        <section class="md-section">
          <h2 class="md-section-title">譜面プレビュー情報</h2>
          <p id="debugScoreMeta" class="ms-debug-meta">未描画</p>
        </section>
        <section class="md-section">
          <h2 class="md-section-title">出力XML</h2>
          <textarea id="outputXml" rows="12" readonly class="md-textarea"></textarea>
        </section>
      </details>
    </section>
  </main>

  <script src="src/js/verovio.js"></script>
  <script src="src/js/midi-writer.js"></script>
  <script src="src/js/main.js"></script>
</body>
</html>
